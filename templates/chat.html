<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8">
	<script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.6.0/socket.io.js"></script>
    <title>Chat App</title>
    <style>
      /* Add styles for the chat app */
      .chat-container {
        display: flex;
        flex-direction: column;
        height: 700px;
        width: 500px;
        margin: 0 auto;
        background-color: #fff;
        border: 1px solid #ccc;
        box-shadow: 2px 2px 4px #ccc;
        border-radius: 4px;
      }
      .chat-header {
        background-color: #f5f5f5;
        padding: 10px;
        border-bottom: 1px solid #ccc;
        text-align: center;
        font-weight: bold;
      }
      .chat-messages {
        padding: 10px;
        display: flex;
        flex-direction: column;
        flex-grow: 1;
        overflow-y: scroll;
      }
      .message {
        margin-bottom: 10px;
        padding: 10px;
        background-color: #f5f5f5;
        border-radius: 4px;
        max-width: 100%;
      }
      .message-username {
        font-weight: bold;
        margin-right: 10px;
        font-family: "Courier New";
      }
		#highlight-connect {
        background-color: #99bbff;
      }
      .chat-input {
        padding: 10px;
        border-top: 1px solid #ccc;
        display: flex;
      }
      .chat-input input {
        flex-grow: 1;
        padding: 5px;
        border: 1px solid #ccc;
        border-radius: 4px;
        outline: none;
        font-family: "Courier New";
      }
      .chat-input button {
        padding: 5px 10px;
        background-color: #4CAF50;
        color: #fff;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        font-family: "Courier New";
      }
      @font-face{
        font-family: gagga;
        src: url("static/LEMONMILK-Bold.otf") format("opentype");
      }
      @font-face{
        font-family: "Courier New", Courier New, Monospace;
      }
      #grönis {
        background-color: #608e45;
        color: whitesmoke;
        font-family: gagga;
        font-size: 50px;
        margin: 10px;
      }
      .message-sent{
        font-family: "Courier New";
      }
    </style>
  </head>
  <body>
    <div class="chat-container">
      <div class="chat-header" id="grönis">
        <h1 id = "grönis">Gagga</h1>
      </div>
      <div class="chat-messages" id="messages">
        <!-- Add messages here -->
			
			<!--
        <div class="message">
          <span class="message-username">{{username}}:</span>
          <span class ="message-sent">Goddag</span>
        </div>-->
		
		
		<script>
		
			function updateScroll()
			{
				var chatMessages = document.querySelector('.chat-messages');
				chatMessages.scrollTop = chatMessages.scrollHeight;
			}
			//Hämta alla meddelande som har skickats hitills
			var messages = {{ messages|tojson|safe }};
				for (var i in messages)
				{
					document.getElementById("messages").innerHTML += '<div class="message"><span class="message-username">' + messages[i]["username"] + ':</span><span class ="message-sent">' + messages[i]["message"] + '<span></div>';
				}
				
			//console.log(messages);
			updateScroll();
		  
		  
		  //Hämta kontinuerligt nya meddelanden från servern 
			var socket = io.connect("http://" + document.domain + ":" + location.port);
			/*
			  socket.on("connect", function() {
			    var data = {
				type: "connect",
				message: "Connected to the server"
				};
				socket.emit("message", data);
			  });*/
			  socket.on("new_connect", function(message) {
				// Någon anslöt
				document.getElementById("messages").innerHTML += '<div class="message" id="highlight-connect"><span class="message-username">' + message + '</span></div>';
				updateScroll();
			  });
			  socket.on("new_message", function(data) {
				// Lägg till dem nya meddelandena
				document.getElementById("messages").innerHTML += '<div class="message"><span class="message-username">' + data["username"] + ':</span><span class ="message-sent">' + data["message"] + '<span></div>';
				updateScroll();
			  });
		</script>
			
      </div>
      <div class="chat-input">
        <input id="message-input" type="text" placeholder="Enter your message">
        <button id="send-button" type="submit">Send</button>
      </div>
	  
	<script>
	
 	function preventHTML(message)
      {
        var newMessage = message;
        newMessage = newMessage.replace(/&/g, "&amp;");
        newMessage = newMessage.replace(/</g, "&lt;");
        newMessage = newMessage.replace(/>/g, "&gt;");
        newMessage = newMessage.replace(/"/g, "&quot;");
        newMessage = newMessage.replace(/'/g, "&#039;");
        return newMessage;
      }
	
	document.getElementById("message-input").addEventListener("keyup", function(event) {
	  if (event.key === "Enter") {
		event.preventDefault();
		document.getElementById("send-button").click();
	  }
	});
	
	  document.getElementById("send-button").addEventListener("click", function(event) {
		event.preventDefault();
		var messageInput = document.getElementById("message-input").value;
		var data = {
		username: "{{username}}",
		message: preventHTML(messageInput)
		};
		socket.emit("message", data);
		document.getElementById("message-input").value = "";
	  });
	  
	//So the page doesn't have to reload everytime a message is sent
	/*
	  document.getElementById("send-button").addEventListener("click", function(event) {
		event.preventDefault();
		var messageInput = document.getElementById("message-input").value;
		var xhr = new XMLHttpRequest();
		xhr.open("POST", "/chat", true);
		xhr.setRequestHeader("Content-Type", "application/x-www-form-urlencoded");
		xhr.onreadystatechange = function() {
		  if (xhr.readyState === XMLHttpRequest.DONE && xhr.status === 200) {
			// Add the message to the messages list
			var messagesContainer = document.querySelector(".chat-messages");
			var message = document.createElement("div");
			message.classList.add("message");
			message.innerHTML = '<span class="message-username">knullapa:</span><span class="message-sent">' + messageInput + '</span>';
			messagesContainer.appendChild(message);
			updateScroll();
		  }
		};
		xhr.send("message=" + messageInput);
	  });*/
	</script>	
    </div>
  </body>
</html>
